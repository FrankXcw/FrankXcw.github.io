# JavaEE面试问题总结

##### @Author LucI_PhAN

## 数据存储和消息队列

### 消息队列

**1. 消息队列的使用场景**

消息队列Message Queue是一种应用程序对应用程序的通信方法。应用程序通过读写出入队列的消息来通信，而无需专用连接来链接它们。消息传递指的是程序之间通过在消息中发送数据进行通信，而不是通过直接调用彼此来通信。直接调用通常是用于诸如远程过程调用的技术。队列的使用除去了接收和发送应用程序同时执行的要求。

1.1 分布式事务  
MQ为面向服务架构SOA提供分布式事务支持，保证全局数据的一致性。

1.2 数据复制  
利用消息中间件用数据从源头复制到多个目的地，从而满足搜索，离线分析和分表规则变化等需求。

1.3 日志同步  
应用通过可靠异步方式将日志同步到消息中间件，可以对日志做实时或离线分析。

1.4 延迟队列  
把消息中间件当做可靠的延迟队列，作为分布式环境下的定时器

1.5 广播通知  
可以作为可靠地集群内广播通知，可用于通知cache失效等事件。

参考：  
[《消息队列（MQ）简介与使用场景》](http://baijiahao.baidu.com/s?id=1549509246303295&wfr=spider&for=pc)  
[《消息队列使用的四种场景介绍》](https://blog.csdn.net/seven__________7/article/details/70225830)


**2. 消息的重发补偿解决思路**


**3. 消息的幂等性解决思路**

MQ为了保证消息必达，消息上下半场均可能发送重复消息，因此需要保证消息的幂等性。  

上半场：  
MQ-client生成inner-msg-id，保证上半场幂等。  
这个ID全局唯一，业务无关，由MQ保证。

下半场：  
业务发送方带入biz-id，业务接收方去重保证幂等。  
这个id对单业务唯一，业务相关，对MQ是透明的。  

因此，幂等性对MQ和业务上下游均有要求。

参考：  
[《MQ之如何做到消息幂等》](https://www.jianshu.com/p/8b77d4583bab?utm_campaign)

**4. 消息的堆积解决思路**

当消息生产太快，消费不过来，导致队列堆积很长，甚至把服务器内存耗尽，这就是消息堆积。

解决方案：  
1. 增加消费者的处理能力，或者减少发布频率
2. 单纯升级硬件只能缓解一时，不是真正的解决办法
3. 考虑使用队列最大长度限制
4. 给消息设置年龄，超时直接丢弃

参考：  
[《MQ队列堆积太长，消费不过来怎么办(转)》](https://www.cnblogs.com/babybluevino/p/3977044.html)

**5. 自己如何实现消息队列**

最本质的消息队列只需要做两件事：  
1. 消息的转储。在更合适的时间点投递，或者通过一系列手段辅助消息最终能送达消费机。
2. 规范一种范式和通用的模式，以满足解耦，最终一致性，错峰等需求。

消息队列的本质就是一个消息转发器，把一次RPC做成了两次RPC。发送者把消息投递到服务端，服务端再将消息转发到接收端。  
一般而言，设计消息队列的整体思路是先确立一个整体的数据流，比如从producer发送给broker，再从broker发送给consumer，consumer回复消费确认，然后broker删除/备份消息等。待数据流构建完成，再利用RPC将数据流串起来。然后考虑RPC的高可用性，尽量做到无状态从而方便水平扩展。之后就需要考虑如果承载消息堆积，然后在合适的时机投递消息。同时为了实现广播功能，必须要维护一份消费关系。可以利用zk/config server等保存消费关系。

参考：  
[《消息队列设计精要》](https://zhuanlan.zhihu.com/p/21649950)

**6. 如何保证消息的有序性**（此题存疑）

消息有序指的是一类消息消费时，能按照发送的顺序来消费。  
要实现严格的顺序消息，简单可行的办法就是保证生产者-MQServer-消费者是一对一对一的关系。但这样设计缺点也很明显，并行度成为了消费系统的瓶颈。  
因此以RocketMQ来举例，一般消息是通过轮询所有队列来发送，以确保负载均衡。而顺序消息可以根据业务，比如说订单号相同的消息发送到同一个队列。在获取到路由信息以后，会根据MessageQueueSelector实现的算法来选择一个队列，同一个OrderId获取到的队列是同一个队列。

参考：  
[《RocketMQ（三）如何解决消息的顺序&重复两大硬伤？》](https://blog.csdn.net/lovesomnus/article/details/51776942)
